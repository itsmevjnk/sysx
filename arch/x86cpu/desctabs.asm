; void gdt_load(gdt_desc_t* desc)
;  Loads the specified GDT descriptor into the GDTR, then
;  flushes the CPU GDT cache.
global gdt_load
gdt_load:
  ; make call frame, probably not needed but it helps with debugging
  push ebp
  mov ebp, esp

  push eax ; retain EAX for good measures

  mov eax, [esp + 12] ; skip past saved EAX, saved EBP and return addr
  lgdt [eax] ; load into GDTR

  ; set up selectors and flush
  mov ax, 0x10
  mov ds, ax
  mov es, ax
  mov fs, ax
  mov gs, ax
  mov ss, ax
  jmp 0x08:.flush ; set CS and flush cache
.flush:
  mov ax, 0x28 ; TSS segment
  ltr ax ; flush TSS

  pop eax ; restore EAX

  ; restore call frame
  mov esp, ebp
  pop ebp
  ret

%macro IDT_HANDLER 1
global idt_handler_%1
idt_handler_%1:
  push %1
  jmp idt_handler_stub
%endmacro

%macro EXC_HANDLER 1
global exc_handler_%1
exc_handler_%1:
  cli
  push %1
  jmp exc_handler_stub
%endmacro

%macro EXC_HANDLER_NOERR 1
global exc_handler_%1
exc_handler_%1:
  cli
  push 0
  push %1
  jmp exc_handler_stub
%endmacro

EXC_HANDLER_NOERR 0
EXC_HANDLER_NOERR 1
EXC_HANDLER_NOERR 2
EXC_HANDLER_NOERR 3
EXC_HANDLER_NOERR 4
EXC_HANDLER_NOERR 5
EXC_HANDLER_NOERR 6
EXC_HANDLER_NOERR 7
EXC_HANDLER 8
EXC_HANDLER_NOERR 9
EXC_HANDLER 10
EXC_HANDLER 11
EXC_HANDLER 12
EXC_HANDLER 13
EXC_HANDLER 14
EXC_HANDLER_NOERR 15
EXC_HANDLER_NOERR 16
EXC_HANDLER 17
EXC_HANDLER_NOERR 18
EXC_HANDLER_NOERR 19
EXC_HANDLER_NOERR 20
EXC_HANDLER_NOERR 21
EXC_HANDLER_NOERR 22
EXC_HANDLER_NOERR 23
EXC_HANDLER_NOERR 24
EXC_HANDLER_NOERR 25
EXC_HANDLER_NOERR 26
EXC_HANDLER_NOERR 27
EXC_HANDLER_NOERR 28
EXC_HANDLER_NOERR 29
EXC_HANDLER 30
EXC_HANDLER_NOERR 31

IDT_HANDLER 32
IDT_HANDLER 33
IDT_HANDLER 34
IDT_HANDLER 35
IDT_HANDLER 36
IDT_HANDLER 37
IDT_HANDLER 38
IDT_HANDLER 39
IDT_HANDLER 40
IDT_HANDLER 41
IDT_HANDLER 42
IDT_HANDLER 43
IDT_HANDLER 44
IDT_HANDLER 45
IDT_HANDLER 46
IDT_HANDLER 47
IDT_HANDLER 48
IDT_HANDLER 49
IDT_HANDLER 50
IDT_HANDLER 51
IDT_HANDLER 52
IDT_HANDLER 53
IDT_HANDLER 54
IDT_HANDLER 55
IDT_HANDLER 56
IDT_HANDLER 57
IDT_HANDLER 58
IDT_HANDLER 59
IDT_HANDLER 60
IDT_HANDLER 61
IDT_HANDLER 62
IDT_HANDLER 63
IDT_HANDLER 64
IDT_HANDLER 65
IDT_HANDLER 66
IDT_HANDLER 67
IDT_HANDLER 68
IDT_HANDLER 69
IDT_HANDLER 70
IDT_HANDLER 71
IDT_HANDLER 72
IDT_HANDLER 73
IDT_HANDLER 74
IDT_HANDLER 75
IDT_HANDLER 76
IDT_HANDLER 77
IDT_HANDLER 78
IDT_HANDLER 79
IDT_HANDLER 80
IDT_HANDLER 81
IDT_HANDLER 82
IDT_HANDLER 83
IDT_HANDLER 84
IDT_HANDLER 85
IDT_HANDLER 86
IDT_HANDLER 87
IDT_HANDLER 88
IDT_HANDLER 89
IDT_HANDLER 90
IDT_HANDLER 91
IDT_HANDLER 92
IDT_HANDLER 93
IDT_HANDLER 94
IDT_HANDLER 95
IDT_HANDLER 96
IDT_HANDLER 97
IDT_HANDLER 98
IDT_HANDLER 99
IDT_HANDLER 100
IDT_HANDLER 101
IDT_HANDLER 102
IDT_HANDLER 103
IDT_HANDLER 104
IDT_HANDLER 105
IDT_HANDLER 106
IDT_HANDLER 107
IDT_HANDLER 108
IDT_HANDLER 109
IDT_HANDLER 110
IDT_HANDLER 111
IDT_HANDLER 112
IDT_HANDLER 113
IDT_HANDLER 114
IDT_HANDLER 115
IDT_HANDLER 116
IDT_HANDLER 117
IDT_HANDLER 118
IDT_HANDLER 119
IDT_HANDLER 120
IDT_HANDLER 121
IDT_HANDLER 122
IDT_HANDLER 123
IDT_HANDLER 124
IDT_HANDLER 125
IDT_HANDLER 126
IDT_HANDLER 127
IDT_HANDLER 128
IDT_HANDLER 129
IDT_HANDLER 130
IDT_HANDLER 131
IDT_HANDLER 132
IDT_HANDLER 133
IDT_HANDLER 134
IDT_HANDLER 135
IDT_HANDLER 136
IDT_HANDLER 137
IDT_HANDLER 138
IDT_HANDLER 139
IDT_HANDLER 140
IDT_HANDLER 141
IDT_HANDLER 142
IDT_HANDLER 143
IDT_HANDLER 144
IDT_HANDLER 145
IDT_HANDLER 146
IDT_HANDLER 147
IDT_HANDLER 148
IDT_HANDLER 149
IDT_HANDLER 150
IDT_HANDLER 151
IDT_HANDLER 152
IDT_HANDLER 153
IDT_HANDLER 154
IDT_HANDLER 155
IDT_HANDLER 156
IDT_HANDLER 157
IDT_HANDLER 158
IDT_HANDLER 159
IDT_HANDLER 160
IDT_HANDLER 161
IDT_HANDLER 162
IDT_HANDLER 163
IDT_HANDLER 164
IDT_HANDLER 165
IDT_HANDLER 166
IDT_HANDLER 167
IDT_HANDLER 168
IDT_HANDLER 169
IDT_HANDLER 170
IDT_HANDLER 171
IDT_HANDLER 172
IDT_HANDLER 173
IDT_HANDLER 174
IDT_HANDLER 175
IDT_HANDLER 176
IDT_HANDLER 177
IDT_HANDLER 178
IDT_HANDLER 179
IDT_HANDLER 180
IDT_HANDLER 181
IDT_HANDLER 182
IDT_HANDLER 183
IDT_HANDLER 184
IDT_HANDLER 185
IDT_HANDLER 186
IDT_HANDLER 187
IDT_HANDLER 188
IDT_HANDLER 189
IDT_HANDLER 190
IDT_HANDLER 191
IDT_HANDLER 192
IDT_HANDLER 193
IDT_HANDLER 194
IDT_HANDLER 195
IDT_HANDLER 196
IDT_HANDLER 197
IDT_HANDLER 198
IDT_HANDLER 199
IDT_HANDLER 200
IDT_HANDLER 201
IDT_HANDLER 202
IDT_HANDLER 203
IDT_HANDLER 204
IDT_HANDLER 205
IDT_HANDLER 206
IDT_HANDLER 207
IDT_HANDLER 208
IDT_HANDLER 209
IDT_HANDLER 210
IDT_HANDLER 211
IDT_HANDLER 212
IDT_HANDLER 213
IDT_HANDLER 214
IDT_HANDLER 215
IDT_HANDLER 216
IDT_HANDLER 217
IDT_HANDLER 218
IDT_HANDLER 219
IDT_HANDLER 220
IDT_HANDLER 221
IDT_HANDLER 222
IDT_HANDLER 223
IDT_HANDLER 224
IDT_HANDLER 225
IDT_HANDLER 226
IDT_HANDLER 227
IDT_HANDLER 228
IDT_HANDLER 229
IDT_HANDLER 230
IDT_HANDLER 231
IDT_HANDLER 232
IDT_HANDLER 233
IDT_HANDLER 234
IDT_HANDLER 235
IDT_HANDLER 236
IDT_HANDLER 237
IDT_HANDLER 238
IDT_HANDLER 239
IDT_HANDLER 240
IDT_HANDLER 241
IDT_HANDLER 242
IDT_HANDLER 243
IDT_HANDLER 244
IDT_HANDLER 245
IDT_HANDLER 246
IDT_HANDLER 247
IDT_HANDLER 248
IDT_HANDLER 249
IDT_HANDLER 250
IDT_HANDLER 251
IDT_HANDLER 252
IDT_HANDLER 253
IDT_HANDLER 254
IDT_HANDLER 255

extern idt_stub
idt_handler_stub:
  pusha

  xor eax, eax
  mov ax, ds
  push eax

  mov ax, 0x10
  mov ds, ax
  mov es, ax
  mov fs, ax
  mov gs, ax

  push esp
  call idt_stub
  add esp, 4

  pop eax
  mov ds, ax
  mov es, ax
  mov fs, ax
  mov gs, ax

  popa
  add esp, 4
  iret

extern exc_stub
exc_handler_stub:
  pusha

  xor eax, eax
  mov ax, ds
  push eax

  mov ax, 0x10
  mov ds, ax
  mov es, ax
  mov fs, ax
  mov gs, ax

  push esp
  call exc_stub
  add esp, 4

  pop eax
  mov ds, ax
  mov es, ax
  mov fs, ax
  mov gs, ax

  popa
  add esp, 8
  iret
